# StoryCraft AI

## Краткий алгоритм работы

1. Отрисовка интерфейса и инициализация WebSocket.
2. Ожидание нажатия кнопки "Старт" пользователем.
3. Формирование начального промпта истории.
4. Генерация текста сюжета с выбором продолжения.
5. Поиск вариантов продолжения сюжета и создание кнопок выбора.
6. Генерация промпта для иллюстрации к рассказанному сегменту.
7. Отображение вариантов выбора.
8. Отправка на генерацию иллюстрации.
9. Полученную иллюстрацию вставляем в рассказанную секцию сюжета.

При нажатии кнопки с вариантом сюжета продолжаем генерацию следующей секции сюжета.

## Пошаговый алгоритм работы

### 1. Инициализация системы
1. **Запуск сервера** (`main.py`)
   - Инициализация FastAPI приложения:
     * Настройка маршрутов API
     * Конфигурация CORS и middleware
   - Настройка WebSocket для real-time коммуникации
   - Загрузка конфигураций:
     * `config/ollama_config.py` - настройки Ollama
     * `config/comfy_config.py` - настройки ComfyUI
   - Проверка доступности сервисов:
     * Ollama API
     * ComfyUI API
   - Подготовка очередей сообщений

2. **Подготовка frontend** (`static/js/main.js`)
   - Загрузка интерфейса:
     * Инициализация WebSocket соединения
     * Настройка обработчиков событий
     * Подготовка контейнеров для контента
   - Параметры соединения:
     * Автоматическое переподключение
     * Обработка таймаутов
     * Буферизация сообщений

### 2. Генерация истории
1. **Фаза стриминга текста** (`app/services/ollama/story_generator.py`)
   - Формирование системного промпта:
     * Инструкции для стиля повествования
     * Требования к структуре текста
     * Правила формирования выборов
   - Параметры генерации Ollama:
     * Модель: OLLAMA_CONFIG["model"]
     * Температура: 0.7
     * Top-p: 0.9
   - Потоковая генерация:
     * Отправка частей текста через WebSocket
     * Обновление интерфейса в реальном времени
     * Сбор полного текста для анализа

2. **Фаза формирования контента** (`app/api/routes/story.py`)
   - Анализ сгенерированного текста:
     * Выделение основного повествования
     * Извлечение вариантов выбора (regex: r'^\\d+[\\.\\)]|^\\*+')
     * Определение ключевых моментов для иллюстрации
   - Структурирование данных:
     * Форматирование текста
     * Подготовка кнопок выбора
     * Метаданные для иллюстрации

### 3. Создание иллюстрации
1. **Подготовка описания сцены** (`app/services/ollama/story_generator.py`)
   - Анализ текста сегмента:
     * Фильтрация диалогов (regex: r'"[^"]*"')
     * Удаление опций выбора
     * Исключение вопросов (regex: r'[^.!?]+\\?')
   - Создание английского описания:
     * Системный промпт для визуального описания
     * Лимит в 30 слов
     * Проверка на кириллицу (regex: [а-яА-Я])
     * До 3-х попыток генерации
     * Fallback: "A mysterious scene with dark atmosphere"

2. **Генерация изображения** (`app/services/comfy/image_generator.py`)
   - Подготовка GPU:
     * Выгрузка моделей Ollama (POST /api/unload)
     * Очистка кэша ComfyUI (POST /free)
     * Проверка памяти (минимум 2GB)
   - Параметры ComfyUI workflow:
     * KSampler - настройки сэмплера
     * CheckpointLoaderSimple - загрузка модели
     * VAELoader - настройки VAE
     * CLIPTextEncode - кодирование текста
   - Обработка результата:
     * Конвертация в base64
     * Привязка к сегменту
     * Отправка на frontend

### 4. Управление ресурсами
1. **Память GPU** (`app/services/comfy/image_generator.py`)
   - Мониторинг через ComfyUI API:
     * GET /system_stats
     * Проверка свободной памяти
   - Управление моделями:
     * Автоматическая выгрузка
     * Очистка кэша
     * Перезапуск сервисов
   - Параметры моделей:
     * gpu_layers: 27
     * num_gpu: 1
     * gpu_memory_utilization: 0.8

2. **Обработка ошибок** (`app/services/ollama/story_generator.py`)
   - Система повторных попыток:
     * max_retries: 3
     * retry_delay: exponential backoff
   - Механизмы fallback:
     * Базовые промпты
     * Альтернативные модели
   - Логирование:
     * Уровень: INFO
     * Формат: [GENERATOR] >>> действие

### 5. Взаимодействие с пользователем
1. **Обработка выбора** (`app/api/routes/story.py`)
   - Получение выбора:
     * Валидация входных данных
     * Обновление контекста
   - Сохранение истории:
     * Последние 3 выбора
     * Текущая глава
     * Состояние сессии

2. **Отображение контента** (`static/js/main.js`)
   - Frontend обновления:
     * Анимация текста
     * Загрузка изображений
     * Состояние кнопок
   - WebSocket события:
     * onmessage - обновление контента
     * onerror - обработка ошибок
     * onclose - переподключение
